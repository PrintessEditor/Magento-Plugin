var __awaiter=this&&this.__awaiter||function(t,a,s,d){return new(s=s||Promise)(function(o,e){function n(t){try{r(d.next(t))}catch(t){e(t)}}function i(t){try{r(d.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?o(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(n,i)}r((d=d.apply(t,a||[])).next())})};class PrintessMagentoIntegration{constructor(t,e,o){this.PRODUCT_FORM_SELECTOR="#product_addtocart_form",this.formatPriceCallback=null,this.shopSettings=t,this.product=e,this.cartItem=o,this.product&&this.product.variants&&this.product.variants.forEach(t=>{t.formFields&&"string"==typeof t.formFields&&(t.formFields=JSON.parse(t.formFields))})}recordForEach(t,e){if(t&&"function"==typeof e)for(const o in t)if(t.hasOwnProperty(o)&&!1===e(o,t[o]))return!1;return!0}filterRecord(t,e){var o={};if(t&&"function"==typeof e)for(const n in t)t.hasOwnProperty(n)&&!0===e(n,t[n])&&(o[n]=t[n]);return o}mapRecord(t,o){const n=[];return t&&"function"==typeof o&&this.recordForEach(t,(t,e)=>{n.push(o(t,e))}),n}parseAttributeId(t){let e=-1;return e=0===t.indexOf("super_attribute[")&&"]"===t[t.length-1]?parseInt(t.substring(16,t.length-1)):e}getVariantOptions(){const e={};return this.product&&this.product.variants&&this.product.variants.forEach(t=>{t.options&&t.options.forEach(t=>{void 0===e[t.optionId]&&(e[t.optionId]={id:t.optionId,name:t.label,values:{}}),void 0===e[t.optionId].values[t.valueIndex]&&(e[t.optionId].values[t.valueIndex]=t.optionTitle)})}),e}getCurrentProductOptions(t="array"){let e=null;var o={selected_configurable_option:!0,related_product:!0,item:!0,form_key:!0,saveToken:!0,thumbnailUrl:!0,printessSaveToken:!0,printessThumbnailUrl:!0,printessItemOptions:!0,product:!0},n=(e="nameLookup"===t||"idLookup"===t?{}:[],document.querySelector(this.PRODUCT_FORM_SELECTOR));if(n){var i,n=new FormData(n),r=this.getVariantOptions();for(const a of n.entries())a[0]&&!o[a[0]]&&(i={name:a[0],value:a[1].toString()},0===a[0].indexOf("super_attribute")&&(i.id=this.parseAttributeId(a[0]),i.valueId=parseInt(a[1]),void 0!==r[i.id])&&(i.name=r[i.id].name,void 0!==r[i.id].values[i.valueId])&&(i.value=r[i.id].values[i.valueId]),"nameLookup"===t?e[i.name]=i:"idLookup"===t?e[i.id]=i:e.push(i))}else console.error("Form not found: "+this.PRODUCT_FORM_SELECTOR);return e}getVariantByProductOptions(t){let i=this.product.variants;if(!i||0===i.length)return null;const n=this.getVariantOptions(),r={};return this.recordForEach(t,(t,e)=>{for(const o in n)n.hasOwnProperty(o)&&n[o].name===t&&(r[t]=e)}),this.recordForEach(r,(o,n)=>{i=i.filter(t=>{let e=!1;return(t.formFields||[]).forEach(t=>{t.name===o&&t.value===n&&(e=!0)}),e})}),0<i.length||(i=this.product.variants,this.recordForEach(r,(e,o)=>{i=i.filter(t=>{return!!t.options&&(t=t.options.filter(t=>t.label===e&&(t.optionTitle===o||t.defaultTitle===o)))&&0<t.length})}),0<i.length)?i[0]:null}addItemsToBasket(t,e,o){var n=document.getElementById("printess-savetoken-field"),i=document.getElementById("printess-thumbnail_url-field"),r=document.getElementById("printess-item_options-field");let a=null;if(n&&(n.value=e,a=n.form),i&&(i.value=o,console.log("thumbnailUrl: "+o),a=a||i.form),r){let e={};this.cartItem?e=this.cartItem.options:this.getCurrentProductOptions("array").forEach(t=>{e[t.name]=t.value}),r.value=JSON.stringify(e)}e=document.getElementById("product-addtocart-button");e?(e.click(),window.require(["Magento_Customer/js/customer-data"],function(e){setTimeout(function(){var t=["cart"];e.invalidate(t),e.reload(t,!0)},1e3)})):a&&a.submit()}saveBasketItem(t,e,o){let n=this.product.entityId||-1,i=this.product.quantity||1;if(window.checkoutConfig&&window.checkoutConfig.quoteItemData){var r=window.checkoutConfig.quoteItemData;let t=null;(t=r&&0<r.length?r.find(t=>t.item_id==this.cartItem.basketItemId):t)&&(n=t.product.entity_id,i=t.qty)}const a=("; "+document.cookie).split("; form_key=").pop().split(";")[0];let s="product="+encodeURIComponent(n);if(s=(s=(s+="&item="+encodeURIComponent(n))+"&selected_configurable_option="+"&related_product=")+("&form_key="+encodeURIComponent(a)),this.cartItem.options)for(var d in this.cartItem.options)this.cartItem.options.hasOwnProperty(d)&&(s+="&"+encodeURIComponent(d)+"="+encodeURIComponent(this.cartItem.options[d]));let c={};this.cartItem?c=this.cartItem.options:this.getCurrentProductOptions("array").forEach(t=>{c[t.name]=t.value});r=this.getVariantByProductOptions(c);r&&(s+="&sku="+encodeURIComponent(r.sku),r)&&r.options&&r.options.forEach(t=>{s=(s+="&"+encodeURIComponent("super_attribute["+t.optionId+"]")+"="+encodeURIComponent(t.valueIndex))+"&"+encodeURIComponent("options["+t.optionId+"]")+"="+encodeURIComponent(t.valueIndex)}),s=(s=(s=(s+="&qty="+encodeURIComponent(i))+"&printess_save_token="+encodeURIComponent(e))+"&printess_thumbnail_url="+encodeURIComponent(o))+"&printessItemOptions="+encodeURIComponent(JSON.stringify(c)),fetch(this.cartItem.addToCartLink,{method:"POST",body:s,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(t=>{s="form_key="+encodeURIComponent(a),s=(s+="&uenc="+encodeURIComponent(this.cartItem.deleteItemJson.data.uenc))+"&id="+encodeURIComponent(this.cartItem.deleteItemJson.data.id),fetch(this.cartItem.deleteItemJson.action,{method:"POST",body:s,headers:{"Content-Type":"application/x-www-form-urlencoded"}}).then(t=>{window.require(["Magento_Customer/js/customer-data"],function(t){var e;t&&(t.invalidate(e=["cart"]),t.reload(e,!0))}),window.location=window.location}).catch(t=>{throw"Unable to add item to basket: "+t.statusText})}).catch(t=>{throw"Unable to add item to basket: "+t.statusText})}static getBasketItemAndProductInfo(d){return __awaiter(this,void 0,void 0,function*(){var t={settings:{},product:{},cartItem:{},saveToken:"",legalText:""},e=yield fetch("/rest/V1/printess/getProductInfo",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify({id:d.product_id,sku:d.product_sku,itemId:d.item_id})});if(!(200<e.status)){let n=yield e.json();"string"==typeof n&&(n=JSON.parse(n));var o=[];if(d.options)for(var i in d.options)d.options.hasOwnProperty(i)&&d.options[i].hasOwnProperty("option_id")&&d.options[i].hasOwnProperty("option_value")&&o.push(d.options[i]);var r=(t,e)=>{if(n.options&&n.options[t])for(const o in n.options[t])if(n.options[t][o]===e)return o;return e},a={};if(d.options)for(var s in d.options)"printess_save_token"!=s&&"printess_thumbnail_url"!=s&&d.options.hasOwnProperty(s)&&(void 0!==d.options[s].value?void 0!==d.options[s].option_id?a["options["+d.options[s].option_id+"]"]=r(d.options[s].option_id,d.options[s].value):a[s]=r(d.options[s].option_id,d.options[s].value):void 0!==d.options[s].option_id?a["options["+d.options[s].option_id+"]"]=r(d.options[s].option_id,d.options[s].value):a[s]=d.options[s]);return t.settings={shopToken:n.editorSettings.shopToken,editorUrl:n.editorSettings.editorUrl,editorVersion:n.editorSettings.editorVersion,startupLogoUrl:n.editorSettings.customLogoUrl,showStartupAnimation:n.editorSettings.showStartupAnimation,hidePricesInEditor:!0===n.editorSettings.hidePriceInEditor,priceFormat:n.priceFormat},t.product={name:n.productName,price:n.productPrice,quantity:d.qty||1,entityId:n.entityId,variants:n.variants},t.cartItem={basketItemId:d.item_id,addToCartLink:n.addToCartLink,deleteItemJson:"string"!=typeof n.deleteJson?n.deleteJson:JSON.parse(n.deleteJson),options:a},t.legalText=n.legalText,t.saveToken=t.cartItem.options.printess_save_token?t.cartItem.options.printess_save_token.value:"",t}alert("Unable to load product information"),console.error(`Unable to load product information [${e.status}] ${e.statusText}: `+(yield e.text()))})}createShopContext(t){t.templateName||console.error("No template name provided");const f=this,o={onRenderFirstPageImage:null,onSave:null,templateNameOrSaveToken:t.templateName,stickers:[],legalText:t.legalText||"",legalTextUrl:t.legalTextUrl||"",snippetPrices:[],chargeEachStickerUsage:!1,hidePricesInEditor:void 0!==this.shopSettings.hidePricesInEditor&&!0===this.shopSettings.hidePricesInEditor,getMergeTemplates:function(){return[]},getProductName:function(){return f.product.name},getPriceInfo:function(){return{}},formatMoney:function(t){if("function"!=typeof f.formatPriceCallback&&"function"==typeof window.require){const e=window.require("Magento_Checkout/js/model/quote"),o=window.require("Magento_Catalog/js/price-utils");e&&o&&(f.formatPriceCallback=function(t){return o.formatPrice(t,e.getPriceFormat())})}return"function"==typeof f.formatPriceCallback?f.formatPriceCallback(t):parseFloat(""+t).toFixed(2)},getCurrentFormFieldValues:function(){let e={};f.cartItem?e=f.cartItem.options:f.getCurrentProductOptions("array").forEach(t=>{e[t.name]=t.value});var t=f.getVariantByProductOptions(e);return t&&t.formFields&&t.formFields.forEach(t=>{e[t.name]=t.value}),e},getPriceForFormFields:function(t){let e={};f.cartItem?e=f.cartItem.options:f.getCurrentProductOptions("array").forEach(t=>{e[t.name]=t.value});var o=f.getVariantByProductOptions(e);return(o||f.product).price},onFormFieldChanged:(t,e,o,n)=>{var i=f.getVariantOptions();let r="",a=0,s="",d=0;for(const m in i)if(i.hasOwnProperty(m)){var c=i[m];if(c.name===t||c.name===o){r=c.name,a=c.id;for(const h in c.values)if(c.values.hasOwnProperty(h)&&(c.values[h]===e||c.values[h]===n)){s=c.values[h],d=parseInt(h);break}if(s)break}}if(s){var p=document.querySelector(".swatch-attribute[data-attribute-id='"+a+"']");if(p){p.setAttribute("data-option-selected",d.toString()),p.querySelectorAll(".swatch-option").forEach(t=>{t.getAttribute("data-option-id")===d.toString()?t.classList.add("selected"):t.classList.remove("selected")});var u=p.querySelector("select.swatch-select");if(u){u.value=d.toString();for(let t=0;t<u.options.length;++t){var l=u.options[t];l.selected=l.value===d.toString()}}}p=document.querySelector("[name='super_attribute\\["+a.toString()+"\\]']");p&&(p.value=d.toString()),f.cartItem&&(f.cartItem.options||(f.cartItem.options={}),f.cartItem.options[r]=s)}},onAddToBasket:function(t,e){(f.cartItem?f.saveBasketItem:f.addItemsToBasket).call(f,o,t,e)},getFormFieldMappings(){return{}}};return o}show(t){this.formatPriceCallback||"function"!=typeof window.require||window.require(["Magento_Catalog/js/price-utils"],e=>{e&&(this.formatPriceCallback=function(t){return e.formatPrice(t,this.shopSettings.priceFormat)})}),"function"==typeof window.initPrintessEditor&&window.initPrintessEditor(this.shopSettings.shopToken,this.shopSettings.editorUrl,this.shopSettings.editorVersion,this.shopSettings.startupLogoUrl,this.shopSettings.showStartupAnimation).show(this.createShopContext(t))}static createFromBasketItem(o){return __awaiter(this,void 0,void 0,function*(){var t=yield PrintessMagentoIntegration.getBasketItemAndProductInfo(o),e=new PrintessMagentoIntegration(t.settings,t.product,t.cartItem);return{legalText:t.legalText,saveToken:t.saveToken,editor:e}})}static editPrintessBasketItem(o){return __awaiter(this,void 0,void 0,function*(){var t={product_sku:o.product_sku,product_id:o.product_id.toString(),options:{},item_id:o.item_id.toString(),qty:o.qty};let e="";(e=o.options&&(o.options.printess_item_options&&(t.options=JSON.parse(o.options.printess_item_options.value)),o.options.printess_save_token)?o.options.printess_save_token.value:e)&&PrintessMagentoIntegration.createFromBasketItem(t).then(t=>{t.editor.show({templateName:e,legalText:t.legalText})})})}};